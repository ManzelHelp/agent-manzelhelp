generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                                                 String             @id @default(cuid()) @db.Uuid
  email                                              String             @unique @db.VarChar(255)
  phone                                              String?            @db.VarChar(20)
  role                                               user_role?         @default(customer)
  is_active                                          Boolean?           @default(true)
  email_verified                                     Boolean?           @default(false)
  first_name                                         String?            @db.VarChar(100)
  last_name                                          String?            @db.VarChar(100)
  avatar_url                                         String?
  date_of_birth                                      DateTime?          @db.Date
  preferred_language                                 String?            @default("fr") @db.VarChar(5)
  created_at                                         DateTime?          @default(now()) @db.Timestamptz(6)
  updated_at                                         DateTime?          @default(now()) @db.Timestamptz(6)
  last_login                                         DateTime?          @db.Timestamptz(6)
  addresses                                          addresses[]
  job_applications                                   job_applications[]
  jobs_jobs_assigned_tasker_idTousers                jobs[]             @relation("jobs_assigned_tasker_idTousers")
  jobs_jobs_customer_idTousers                       jobs[]             @relation("jobs_customer_idTousers")
  messages_messages_receiver_idTousers               Message[]          @relation("messages_receiver_idTousers")
  messages_messages_sender_idTousers                 Message[]          @relation("messages_sender_idTousers")
  notifications_notifications_related_user_idTousers notifications[]    @relation("notifications_related_user_idTousers")
  notifications_notifications_user_idTousers         notifications[]    @relation("notifications_user_idTousers")
  promotions                                         promotions[]
  reviews_reviews_reviewee_idTousers                 Review[]           @relation("reviews_reviewee_idTousers")
  reviews_reviews_reviewer_idTousers                 Review[]           @relation("reviews_reviewer_idTousers")
  tasker_profiles                                    tasker_profiles?
  tasker_services                                    tasker_services[]
  transactions_transactions_payee_idTousers          transactions[]     @relation("transactions_payee_idTousers")
  transactions_transactions_payer_idTousers          transactions[]     @relation("transactions_payer_idTousers")
  user_stats                                         user_stats?

  @@index([is_active], map: "idx_users_active")
  @@index([email], map: "idx_users_email")
  @@index([phone], map: "idx_users_phone")
  @@index([role], map: "idx_users_role")
  @@map("users")
}

model Service {
  id                 Int                @id @default(autoincrement())
  category_id        Int
  name_en            String             @db.VarChar(100)
  name_fr            String             @db.VarChar(100)
  name_ar            String             @db.VarChar(100)
  description_en     String?
  description_fr     String?
  description_ar     String?
  icon_url           String?
  is_active          Boolean?           @default(true)
  sort_order         Int?               @default(0)
  created_at         DateTime?          @default(now()) @db.Timestamptz(6)
  jobs               jobs[]
  service_categories service_categories @relation(fields: [category_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tasker_services    tasker_services[]

  @@index([is_active], map: "idx_services_active")
  @@index([category_id], map: "idx_services_category_id")
  @@map("services")
}

model Review {
  id                               Int       @id @default(autoincrement())
  job_id                           String    @db.Uuid
  reviewer_id                      String    @db.Uuid
  reviewee_id                      String    @db.Uuid
  overall_rating                   Int
  quality_rating                   Int?
  communication_rating             Int?
  timeliness_rating                Int?
  comment                          String?
  created_at                       DateTime? @default(now()) @db.Timestamptz(6)
  jobs                             jobs      @relation(fields: [job_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users_reviews_reviewee_idTousers User      @relation("reviews_reviewee_idTousers", fields: [reviewee_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users_reviews_reviewer_idTousers User      @relation("reviews_reviewer_idTousers", fields: [reviewer_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([job_id], map: "idx_reviews_job_id")
  @@index([overall_rating], map: "idx_reviews_rating")
  @@index([reviewee_id], map: "idx_reviews_reviewee_id")
  @@map("reviews")
}

model Message {
  id                                Int       @id @default(autoincrement())
  job_id                            String    @db.Uuid
  sender_id                         String    @db.Uuid
  receiver_id                       String    @db.Uuid
  content                           String
  attachment_url                    String?
  is_read                           Boolean?  @default(false)
  created_at                        DateTime? @default(now()) @db.Timestamptz(6)
  jobs                              jobs      @relation(fields: [job_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users_messages_receiver_idTousers User      @relation("messages_receiver_idTousers", fields: [receiver_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users_messages_sender_idTousers   User      @relation("messages_sender_idTousers", fields: [sender_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([created_at], map: "idx_messages_created_at")
  @@index([job_id], map: "idx_messages_job_id")
  @@index([receiver_id, is_read], map: "idx_messages_receiver_unread")
  @@map("messages")
}

model addresses {
  id             Int                       @id @default(autoincrement())
  user_id        String                    @db.Uuid
  label          String?                   @default("home") @db.VarChar(50)
  street_address String
  city           String                    @db.VarChar(100)
  region         String                    @db.VarChar(100)
  postal_code    String?                   @db.VarChar(20)
  country        String?                   @default("MA") @db.Char(2)
  location       Unsupported("geography")?
  is_default     Boolean?                  @default(false)
  created_at     DateTime?                 @default(now()) @db.Timestamptz(6)
  updated_at     DateTime?                 @default(now()) @db.Timestamptz(6)
  users          User                      @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  jobs           jobs[]

  @@index([city], map: "idx_addresses_city")
  @@index([location], map: "idx_addresses_location", type: Gist)
  @@index([user_id], map: "idx_addresses_user_id")
}

model job_applications {
  id                 Int                 @id @default(autoincrement())
  job_id             String              @db.Uuid
  tasker_id          String              @db.Uuid
  proposed_price     Decimal             @db.Decimal(10, 2)
  estimated_duration Int?
  message            String?
  status             application_status? @default(pending)
  is_premium         Boolean?            @default(false)
  created_at         DateTime?           @default(now()) @db.Timestamptz(6)
  updated_at         DateTime?           @default(now()) @db.Timestamptz(6)
  jobs               jobs                @relation(fields: [job_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users              User                @relation(fields: [tasker_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([job_id], map: "idx_job_applications_job_id")
  @@index([status], map: "idx_job_applications_status")
  @@index([tasker_id], map: "idx_job_applications_tasker_id")
}

model jobs {
  id                                   String             @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  customer_id                          String             @db.Uuid
  service_id                           Int
  address_id                           Int
  title                                String             @db.VarChar(200)
  description                          String
  preferred_date                       DateTime           @db.Date
  preferred_time_start                 DateTime?          @db.Time(6)
  preferred_time_end                   DateTime?          @db.Time(6)
  is_flexible                          Boolean?           @default(false)
  estimated_duration                   Int?
  customer_budget                      Decimal?           @db.Decimal(10, 2)
  final_price                          Decimal?           @db.Decimal(10, 2)
  is_promoted                          Boolean?           @default(false)
  promotion_expires_at                 DateTime?          @db.Timestamptz(6)
  promotion_boost_score                Int?               @default(0)
  status                               job_status?        @default(pending)
  assigned_tasker_id                   String?            @db.Uuid
  started_at                           DateTime?          @db.Timestamptz(6)
  completed_at                         DateTime?          @db.Timestamptz(6)
  created_at                           DateTime?          @default(now()) @db.Timestamptz(6)
  updated_at                           DateTime?          @default(now()) @db.Timestamptz(6)
  job_applications                     job_applications[]
  addresses                            addresses          @relation(fields: [address_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users_jobs_assigned_tasker_idTousers User?              @relation("jobs_assigned_tasker_idTousers", fields: [assigned_tasker_id], references: [id], onUpdate: NoAction)
  users_jobs_customer_idTousers        User               @relation("jobs_customer_idTousers", fields: [customer_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  services                             Service            @relation(fields: [service_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  messages                             Message[]
  notifications                        notifications[]
  promotions                           promotions[]
  reviews                              Review[]
  transactions                         transactions[]

  @@index([assigned_tasker_id], map: "idx_jobs_assigned_tasker")
  @@index([promotion_boost_score(sort: Desc)], map: "idx_jobs_boost_score")
  @@index([created_at], map: "idx_jobs_created_at")
  @@index([customer_id], map: "idx_jobs_customer_id")
  @@index([preferred_date], map: "idx_jobs_date")
  @@index([is_promoted, promotion_expires_at], map: "idx_jobs_promoted")
  @@index([service_id], map: "idx_jobs_service_id")
  @@index([status], map: "idx_jobs_status")
}

model notifications {
  id                                         Int               @id @default(autoincrement())
  user_id                                    String            @db.Uuid
  type                                       notification_type
  title                                      String            @db.VarChar(200)
  message                                    String
  related_job_id                             String?           @db.Uuid
  related_user_id                            String?           @db.Uuid
  is_read                                    Boolean?          @default(false)
  created_at                                 DateTime?         @default(now()) @db.Timestamptz(6)
  jobs                                       jobs?             @relation(fields: [related_job_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users_notifications_related_user_idTousers User?             @relation("notifications_related_user_idTousers", fields: [related_user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users_notifications_user_idTousers         User              @relation("notifications_user_idTousers", fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([created_at], map: "idx_notifications_created_at")
  @@index([user_id, is_read], map: "idx_notifications_user_unread")
}

model promotion_packages {
  id                     Int          @id @default(autoincrement())
  name_en                String       @db.VarChar(100)
  name_fr                String       @db.VarChar(100)
  name_ar                String       @db.VarChar(100)
  description_en         String?
  description_fr         String?
  description_ar         String?
  price                  Decimal      @db.Decimal(10, 2)
  duration_days          Int
  boost_score            Int
  priority_listing       Boolean?     @default(false)
  featured_badge         Boolean?     @default(false)
  social_media_promotion Boolean?     @default(false)
  email_promotion        Boolean?     @default(false)
  is_active              Boolean?     @default(true)
  created_at             DateTime?    @default(now()) @db.Timestamptz(6)
  promotions             promotions[]
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model promotions {
  id                 Int                @id @default(autoincrement())
  package_id         Int
  user_id            String             @db.Uuid
  job_id             String?            @db.Uuid
  tasker_service_id  Int?
  amount_paid        Decimal            @db.Decimal(10, 2)
  boost_score        Int
  starts_at          DateTime?          @default(now()) @db.Timestamptz(6)
  expires_at         DateTime           @db.Timestamptz(6)
  is_active          Boolean?           @default(true)
  created_at         DateTime?          @default(now()) @db.Timestamptz(6)
  updated_at         DateTime?          @default(now()) @db.Timestamptz(6)
  jobs               jobs?              @relation(fields: [job_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  promotion_packages promotion_packages @relation(fields: [package_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tasker_services    tasker_services?   @relation(fields: [tasker_service_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users              User               @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([is_active, expires_at], map: "idx_promotions_active")
  @@index([expires_at], map: "idx_promotions_expires_at")
  @@index([job_id], map: "idx_promotions_job_id")
  @@index([tasker_service_id], map: "idx_promotions_tasker_service_id")
  @@index([user_id], map: "idx_promotions_user_id")
}

model service_categories {
  id             Int       @id @default(autoincrement())
  name_en        String    @db.VarChar(100)
  name_fr        String    @db.VarChar(100)
  name_ar        String    @db.VarChar(100)
  description_en String?
  description_fr String?
  description_ar String?
  icon_url       String?
  is_active      Boolean?  @default(true)
  sort_order     Int?      @default(0)
  created_at     DateTime? @default(now()) @db.Timestamptz(6)
  services       Service[]

  @@index([is_active], map: "idx_service_categories_active")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model spatial_ref_sys {
  srid      Int     @id
  auth_name String? @db.VarChar(256)
  auth_srid Int?
  srtext    String? @db.VarChar(2048)
  proj4text String? @db.VarChar(2048)
}

model tasker_profiles {
  id                    String               @id @db.Uuid
  experience_level      experience_level?
  bio                   String?
  identity_document_url String?
  verification_status   verification_status? @default(pending)
  service_radius_km     Int?                 @default(50)
  is_available          Boolean?             @default(true)
  updated_at            DateTime?            @default(now()) @db.Timestamptz(6)
  users                 User                 @relation(fields: [id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([is_available], map: "idx_tasker_profiles_available")
  @@index([verification_status], map: "idx_tasker_profiles_verification")
}

model tasker_services {
  id                    Int           @id @default(autoincrement())
  tasker_id             String        @db.Uuid
  service_id            Int
  pricing_type          pricing_type? @default(fixed)
  base_price            Decimal       @db.Decimal(10, 2)
  hourly_rate           Decimal?      @db.Decimal(10, 2)
  is_available          Boolean?      @default(true)
  is_promoted           Boolean?      @default(false)
  promotion_expires_at  DateTime?     @db.Timestamptz(6)
  promotion_boost_score Int?          @default(0)
  created_at            DateTime?     @default(now()) @db.Timestamptz(6)
  updated_at            DateTime?     @default(now()) @db.Timestamptz(6)
  promotions            promotions[]
  services              Service       @relation(fields: [service_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users                 User          @relation(fields: [tasker_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([is_available], map: "idx_tasker_services_available")
  @@index([promotion_boost_score(sort: Desc)], map: "idx_tasker_services_boost_score")
  @@index([is_promoted, promotion_expires_at], map: "idx_tasker_services_promoted")
  @@index([service_id], map: "idx_tasker_services_service_id")
  @@index([tasker_id], map: "idx_tasker_services_tasker_id")
}

model transactions {
  id                                 Int              @id @default(autoincrement())
  job_id                             String           @db.Uuid
  payer_id                           String           @db.Uuid
  payee_id                           String           @db.Uuid
  transaction_type                   transaction_type
  amount                             Decimal          @db.Decimal(10, 2)
  platform_fee                       Decimal?         @default(0) @db.Decimal(10, 2)
  payment_status                     payment_status?  @default(pending)
  payment_method                     String?          @db.VarChar(50)
  external_payment_id                String?          @db.VarChar(100)
  processed_at                       DateTime?        @db.Timestamptz(6)
  created_at                         DateTime?        @default(now()) @db.Timestamptz(6)
  updated_at                         DateTime?        @default(now()) @db.Timestamptz(6)
  jobs                               jobs             @relation(fields: [job_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users_transactions_payee_idTousers User             @relation("transactions_payee_idTousers", fields: [payee_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users_transactions_payer_idTousers User             @relation("transactions_payer_idTousers", fields: [payer_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([created_at], map: "idx_transactions_created_at")
  @@index([job_id], map: "idx_transactions_job_id")
  @@index([payee_id], map: "idx_transactions_payee_id")
  @@index([payer_id], map: "idx_transactions_payer_id")
  @@index([payment_status], map: "idx_transactions_status")
}

model user_stats {
  id                  String    @id @db.Uuid
  tasker_rating       Decimal?  @default(0.00) @db.Decimal(3, 2)
  total_reviews       Int?      @default(0)
  completed_jobs      Int?      @default(0)
  total_earnings      Decimal?  @default(0.00) @db.Decimal(12, 2)
  response_time_hours Int?      @default(0)
  cancellation_rate   Decimal?  @default(0.00) @db.Decimal(5, 2)
  jobs_posted         Int?      @default(0)
  total_spent         Decimal?  @default(0.00) @db.Decimal(12, 2)
  updated_at          DateTime? @default(now()) @db.Timestamptz(6)
  users               User      @relation(fields: [id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([completed_jobs], map: "idx_user_stats_completed_jobs")
  @@index([tasker_rating], map: "idx_user_stats_rating")
}

enum PriceType {
  HOURLY
  FIXED
  NEGOTIABLE
}

enum BookingStatus {
  PENDING
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  DISPUTED
}

enum application_status {
  pending
  accepted
  rejected
  withdrawn
}

enum experience_level {
  beginner
  intermediate
  expert
}

enum job_status {
  pending
  active
  in_progress
  completed
  cancelled
}

enum notification_type {
  job_created
  application_received
  application_accepted
  job_completed
  payment_received
  message_received
}

enum payment_status {
  pending
  paid
  failed
  refunded
}

enum pricing_type {
  fixed
  hourly
  per_item
}

enum transaction_type {
  job_payment
  platform_fee
  premium_application
  refund
  job_promotion
  service_promotion
}

enum user_role {
  customer
  tasker
  both
  admin
}

enum verification_status {
  pending
  verified
  rejected
}
